<?xml version="1.0" encoding="utf-8"?>
<executable>

  <category>Registration</category>
  <title>Anisotropic Diffusive Deformable Registration (TubeTK)</title>
  <description>Performs registration between images depicting sliding organs, using an anisotropic diffusive regularization.</description>
  <version>0.1.0.$Revision: 2104 $(alpha)</version>
  <documentation-url>http://public.kitware.com/Wiki/TubeTK</documentation-url>
  <license>Apache 2.0</license>
  <contributor>Danielle F. Pace, Kitware</contributor>
  <acknowledgements>This work is part of the TubeTK project at Kitware</acknowledgements>

  <parameters>
    <label>Registration Parameters</label>
    <description>Parameters used for registration</description>
    <integer>
      <name>numberOfIterations</name>
      <flag>i</flag>
      <longflag>iterations</longflag>
      <label>Iterations</label>
      <channel>input</channel>
      <description>Number of iterations.</description>
      <default>20</default>
    </integer>
    <double>
      <name>timeStep</name>
      <flag>s</flag>
      <longflag>timestep</longflag>
      <label>Time Step</label>
      <channel>input</channel>
      <description>Time step duration.</description>
      <default>0.125</default>
    </double>
  </parameters>

  <parameters>
    <label>Organ Boundaries and Weights</label>
    <description>Parameters specifying organ boundaries and weighting terms</description>
    <geometry type="model">
      <name>organBoundaryFileName</name>
      <channel>input</channel>
      <label>Input Organ Boundary</label>
      <flag>b</flag>
      <longflag>organBoundary</longflag>
      <description>Filename of the organ boundary surface model.  This should be in the space of the fixed image</description>
    </geometry>
    <image type="vector">
      <name>inputNormalVectorImageFileName</name>
      <label>Input Normal Vector Image</label>
      <flag>n</flag>
      <longflag>inputNormalVectorImage</longflag>
      <channel>input</channel>
      <description>Image specifying the normal vectors.  This should be in the space of the fixed image.  Optional: supply a normal vector image or an organ boundary surface.  If both are provided, the organ boundary surface is used.</description>
    </image>
    <image>
      <name>inputWeightRegularizationsImageFileName</name>
      <label>Input Regularization Weight Image</label>
      <flag>w</flag>
      <longflag>inputWeightRegularizationsImage</longflag>
      <channel>input</channel>
      <description>Image specifying the weights between the anisotropic diffusive regularization and the diffusive regularization, typically a function of distance to the organ boundary.  This should be in the space of the fixed image.  Optional: supply a weight image or an organ boundary surface (and a lambda).  If both are provided, the organ boundary surface is used.</description>
    </image>
    <image>
      <name>inputWeightStructuresImageFileName</name>
      <label>Input Structure Weight Image</label>
      <flag>e</flag>
      <longflag>inputWeightStructuresImage</longflag>
      <channel>input</channel>
      <description>Image specifying the the matrices weighting between plane, tube and point-like structures.  This is applicable for sparse sliding organ registration only.  This image should be in the space of the fixed image.  Optional: supply a weight image or an organ boundary surface (and a lambda).  If both are provided, the organ boundary surface is used.</description>
    </image>
  </parameters>

  <parameters>
    <label>IO</label>
    <description>Input/output parameters</description>
    <transform fileExtensions=".txt">
      <name>initialTransform</name>
      <flag>t</flag>
      <longflag>initialTransform</longflag>
      <description>Initial transform for aligning the fixed and moving image. When applied to the moving image, should make it look closer to the fixed image. Optional.</description>
      <label>Initial Transform</label>
      <channel>input</channel>
    </transform>
    <image>
      <name>fixedImageFileName</name>
      <label>Input Fixed Image</label>
      <channel>input</channel>
      <index>0</index>
      <description>Fixed image to which to register</description>
    </image>
    <image>
      <name>movingImageFileName</name>
      <label>Input Moving Image</label>
      <channel>input</channel>
      <index>1</index>
      <description>Moving image</description>
    </image>
    <image type="vector">
      <name>outputDeformationFieldFileName</name>
      <flag>d</flag>
      <longflag>outputDeformationField</longflag>
      <description>Deformation field calculated that aligns the fixed and moving image.  Maps positions from the fixed coordinate frame to the moving coordinate frame.  Optional (specify an output deformation field or an output volume or both).</description>
      <label>Output Deformation Field</label>
      <channel>output</channel>
    </image>
    <!--
    <transform fileExtensions=".nrrd" type="nonlinear" reference="movingImageFileName">
      <name>outputTransformFileName</name>
      <flag>y</flag>
      <longflag>outputTransform</longflag>
      <description>Deformation field calculated that aligns the fixed and moving image.  Maps positions from the fixed coordinate frame to the moving coordinate frame.  Optional (specify an output deformation field or an output volume or both).</description>
      <label>Output Transform</label>
      <channel>output</channel>
    </transform>
    -->
    <image>
      <name>outputResampledImageFileName</name>
      <flag>o</flag>
      <longflag>outputResampledMovingFileName</longflag>
      <label>Output Volume</label>
      <channel>output</channel>
      <description>Resampled moving image to fixed image coordinate frame. Optional (specify an output deformation field or an output volume or both).</description>
    </image>
    <image type="vector">
      <name>outputNormalVectorImageFileName</name>
      <label>Output Normal Vector Image</label>
      <flag>v</flag>
      <longflag>outputNormalVectorImage</longflag>
      <channel>output</channel>
      <description>Image specifying the normal vectors.  This is in the space of the fixed image.  Optional: allows you to save the normal vector image when providing an organ boundary surface.  On later registrations, you can provide it instead of an organ boundary, so that it doesn't need to be recalculated.</description>
    </image>
    <image>
      <name>outputWeightRegularizationsImageFileName</name>
      <label>Output Weight Regularizations Image</label>
      <flag>x</flag>
      <longflag>outputWeightRegularizationsImage</longflag>
      <channel>output</channel>
      <description>Image specifying the weights between the anisotropic diffusive regularization and the diffusive regularization, typically a function of distance to the organ boundary.  This is in the space of the fixed image.  Optional: allows you to save the weight image when providing an organ boundary surface. On later registrations, you can provide it instead of an organ boundary, so that it doesn't need to be recalculated.</description>
    </image>
    <image>
      <name>outputWeightStructuresImageFileName</name>
      <label>Output Weight Structures Image</label>
      <flag>z</flag>
      <longflag>outputWeightStructuresImage</longflag>
      <channel>output</channel>
      <description>Image specifying the the matrices weighting between plane, tube and point-like structures.  This is applicable for sparse sliding organ registration only.  This is in the space of the fixed image.  Optional: allows you to save the weight image when providing an organ boundary surface. On later registrations, you can provide it instead of an organ boundary, so that it doesn't need to be recalculated..</description>
    </image>
  </parameters>

  <parameters advanced="true">
    <label>Advanced Parameters</label>
    <description>Advanced parameters</description>
    <double>
      <name>lambda</name>
      <flag>l</flag>
      <longflag>lambda</longflag>
      <label>Lambda</label>
      <channel>input</channel>
      <description>Controls the exponential decay used to calculate the weight value as a function of the distance to the closest organ border point.  Must be negative (for exponential decay).</description>
      <default>-0.1</default>
      <constraints>
        <minimum>-10.0</minimum>
        <maximum>0.0</maximum>
        <step>0.01</step>
      </constraints>
    </double>
    <boolean>
      <name>doNotPerformRegularization</name>
      <flag>r</flag>
      <longflag>doNotPerformRegularization</longflag>
      <label>Do not perform regularization</label>
      <channel>input</channel>
      <description>Whether or not to perform motion field regularization</description>
      <default>false</default>
    </boolean>
    <boolean>
      <name>doNotUseAnisotropicRegularization</name>
      <flag>a</flag>
      <longflag>doNotUseAnisotropicRegularization</longflag>
      <label>Do not use anisotropic regularization</label>
      <channel>input</channel>
      <description>Whether or not to use the anisotropic diffusive regularization (if true, uses the diffusive regularization (i.e. Gaussian smoothing)</description>
      <default>false</default>
    </boolean>
    <string-enumeration>
      <name>anisotropicRegistrationType</name>
      <flag>u</flag>
      <longflag>anisotropicRegistrationType</longflag>
      <label>Anisotropic Registration Type</label>
      <channel>input</channel>
      <element>SlidingOrgan</element>
      <element>SparseSlidingOrgan</element>
      <description>The type of the anisotropic registration.  Each voxel has one normal in the "Sliding Organ" type, and three normals in the "Sparse Sliding Organ" type.  "Sparse Sliding Organ" is under development and not recommended.</description>
      <default>SlidingOrgan</default>
    </string-enumeration>
    <string-enumeration>
      <name>worldCoordinateSystem</name>
      <flag>c</flag>
      <longflag>worldCoordinateSystem</longflag>
      <label>World Coordinate System</label>
      <channel>input</channel>
      <element>RAS</element>
      <element>LPS</element>
      <description>The world coordinate system.  RAS if the images and model are aligned when visualized in 3D Slicer, LPS if the images and model are aligned when visualized in Paraview.</description>
      <default>RAS</default>
    </string-enumeration>
  </parameters>

</executable>
